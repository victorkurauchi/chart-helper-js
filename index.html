<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Dynamic helper chart.</title>

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="http://silviomoreto.github.io/bootstrap-select/stylesheets/bootstrap-select.css" rel="stylesheet">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="http://silviomoreto.github.io/bootstrap-select/javascripts/bootstrap-select.js"></script>
	<script src="https://www.google.com/jsapi"></script>
    <!-- Font -->
    <script src="http://use.typekit.net/ajf8ggy.js"></script>
    <script>
        try { Typekit.load(); } catch (e) {}
    </script>
</head>

<body>
	<div class="container">
		<div class="row-fluid">
			<div class="span12">
				<table class="table table-hover" id="result-report-table">
					<thead>
						<tr>
							<th id="Nome">Nome</th>
							<th id="Area">Area</th>
							<th id="Especialidade">Especialidade</th>
						</tr>
					</thead>
				
					<tbody>
						<tr>		
							<td>Jack Chan</td>
							<td>Front-end</td>
							<td>Javascript</td>
						</tr>
						<tr>		
							<td>Luke Pritchard</td>
							<td>Back-end</td>
							<td>Ruby</td>
						</tr>
						<tr>		
							<td>Melina</td>
							<td>Design</td>
							<td>Illustrator</td>
						</tr>
						<tr>		
							<td>Roctiv</td>
							<td>Front-end</td>
							<td>Javascript</td>
						</tr>
					</tbody>
				</table>

				<hr/>

				<div id="chart-option" class="pull-left">	
					<label><strong>Opções para gráfico</strong></label>
					<div class="input-append">
						<select class="selectpicker" data-width="160px" id="appendedInput">
							<option value="Nome">Nome</option>
							<option value="Area">Area</option>
							<option value="Especialidade">Especialidade</option>
						</select>
						<span class="btn add-on" id="gerar-grafico">Gerar <i class="icon-chevron-right"></i></span>
					</div>
				</div>

				<!--Div that will hold the pie chart-->
				<div id="chart_div" class="pull-left"></div>
			</div>
		<div>	
	</div>
</body>

<script>
google.load('visualization', '1.0', {'packages':['corechart']});
$(document).ready(function() {

	<!-- Google Charts ! -->

	// Manipular escolha de variações no gráfico
	var lastElement = '';
	var data = null;
	var variacao = "" ;

    $('#appendedInput').change(function() {
    	
    	$("#appendedInput option:selected").each(function () {
    		var selected = $(this).val();
    		if (selected !== lastElement) {
    			variacao = $(this).val();
    		}
    		
    		lastElement = selected;
  		});
	});

	$(document.body).on('click', '#gerar-grafico', function() {
		drawChart(variacao);
	});

	// Baseado no array selecionado para fitlro pelo usuário, percorremos todos os elementos,
	// verificamos se aquele índice já existe, se sim, incrementamos o número de repetições,
	// senão, criamos um novo índice e armazenamos também as repetições que ele percorre.
	function countInArray(array) {
		console.log("Recebido: " + array);
	    var arrayAuxiliar = [];
	    var arr = array.length,
    		len, i;

    	for (i = 0, len = arr; i < len; i++) {

    		if (arrayAuxiliar[array[i]] >= 1) {
    			arrayAuxiliar[array[i]]++;
    		}
    		else {
    			arrayAuxiliar[array[i]] = 1;
    		}
	    }
	    return arrayAuxiliar;
	}

	// Função para validar string
	var toString = Object.prototype.toString;
	_isString = function (obj) {
  		return toString.call(obj) == '[object String]';
	}

 	// Callback that creates and populates a data table,
    // instantiates the pie chart, passes in the data and
    // draws it.
	function drawChart(variacao) {

		// Variacao precisar ter exatamente o mesmo nome, tanto no cabecalho quanto no selectbox
		// O id dos elementos do cabecalho precisam ter o mesmo valor do nome em exibição, pois virão dinâmicamente
		// e este modo é o mais simples para obter.

		// Criando a tabela.
    	data = new google.visualization.DataTable();
		var arrayColunasSelecionadas = [];
		var colunasAplicadas;

		// A função index() do jQuery inicia em 0. 
		// Portanto, caso a coluna seja a número 2, o index será 1 e assim adiante.
		// Obtemos a posição em que a coluna selecionada pelo usuário está.
		var posicaoColuna = $("tr:first th#"+variacao).index() + 1;

		// Obtemos aqui todos os registros abaixo do header da coluna selecionada.
		colunasAplicadas = $("#result-report-table tr td:nth-child(" + posicaoColuna + ")");

		// Para cada coluna que iremos buscar, precisaremos ver o conteúdo da mesma,
		// Caso seja igual, criar um objeto com seu id, nome e a quantidade de vezes que este registro aparece
		$(colunasAplicadas).each(function(indexColuna, valorColuna) {
			// Dentro deste loop, criamos um array armazenando todas os registros existentes na coluna selecionada.
			arrayColunasSelecionadas.push($(this).text());
		});

		data.addColumn('string', variacao);
		data.addColumn('number', variacao);

		// A variável objetoFiltrado receberá um array contendo [quantidade e descrição].
		// Este array é populado na função que chamamos passando como parâmetro todas as colunas selecionadas
		// a partir da escolha do usuário.
		var objetoFiltrado = countInArray(arrayColunasSelecionadas);

		// Iteramos o array recebido
		// item é a chave, objetoFiltrao[item] é o valor.
		// descrição e quantidade, respectivamente.
		for (item in objetoFiltrado) {
			console.log(item);
		  	console.log(objetoFiltrado[item]);
		  	data.addRow([item, objetoFiltrado[item]]);
		}
			
	    // Set chart options
	    var options = {'title':'Gráfico',
	                   'width':600,
	                   'height':300,
	                   is3D: true};

	    // Instantiate and draw our chart, passing in some options.
	    var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
	    chart.draw(data, options);
	}
});	
</script>